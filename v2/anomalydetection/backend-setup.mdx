---
sidebar_position: 3
title: Backend Setup
hide_title: true
---

# Setting up the Backend

In order to use the anomaly detection service, a request to the following enpoint needs to be made:

```typescript
POST https://security-us-east-1.aws.supertokens.io/v1/security
```

You can view the HTTP API reference for this endpoint [here](#somelinkhere).

### Retrieving the Request ID

The reuqest ID that has been passed from the frontend is available in the `requestId` property of the input body from each API override.

Below is an example of how to retrieve the request ID from the input body:

```typescript
const generatePasswordResetTokenPOST = async function (input) {
    // ... your code here ...
    const requestId = (await input.options.req.getJSONBody()).requestId;
    // ... your code here ...
}
```

### Making the Request to the Anomaly Detection endpoint

The request body is a JSON object that contains the following properties (all fields are optional):

- `securityServiceRequestId`: The request ID that has been generated on the frontend.
- `bruteForce`: An array of brute force checks that have been configured on the frontend.
```typescript
type BruteForceCheck = {
    keyStr: string;
    maxRequests: {
                limit: number;
                perTimeIntervalMS: number;
        }[];
    }
}
```
- `passwordHash`: The SHA-1 hash of the password that needs to be checked against the breach database.
- `email`: The email address that is being used for the authentication event.
- `phoneNumber`: The phone number that is being used for the authentication event.
- `actionType`: The type of action that is being performed. The possible values are:
      - `emailpassword-sign-in`
      - `emailpassword-sign-up`
      - `send-password-reset-email`
      - `passwordless-send-email`
      - `passwordless-send-sms`
      - `totp-verify-device`
      - `totp-verify-totp`
      - `thirdparty-login`
      - `emailverification-send-email`


Below is an example of how to make the request to the anomaly detection endpoint:

```typescript
const API_KEY = "<api-key>"; // Your secret API key that you received from the SuperTokens team
const ANOMALY_DETECTION_API_URL = "https://security-us-east-1.aws.supertokens.io/v1/security";

async function doSecurityChecks(input: {
    actionType?: string,
    email?: string,
    phoneNumber?: string,
    password?: string,
    securityServiceRequestId?: string,
    bruteForceChecks?: {
        keyStr: string,
        maxRequests: {
            limit: number,
            perTimeIntervalMS: number
        }[]
    }[]
}): Promise<{
    status: "GENERAL_ERROR",
    message: string
} | undefined> {
    let requestBody: {
        email?: string;
        phoneNumber?: string;
        actionType?: string;
        securityServiceRequestId?: string;
        passwordHash?: string;
        bruteForce?: {
            keyStr: string;
            maxRequests: {
                limit: number;
                perTimeIntervalMS: number;
            }[];
        }[];
    } = {}

    if (input.securityServiceRequestId !== undefined) {
        requestBody.securityServiceRequestId = input.securityServiceRequestId;
    }

    if (input.password !== undefined) {
        let shasum = createHash('sha1');
        shasum.update(input.password);
        const passwordHash = shasum.digest('hex');
        requestBody.passwordHash = passwordHash;
    }
    requestBody.bruteForce = input.bruteForce;
    requestBody.email = input.email;
    requestBody.phoneNumber = input.phoneNumber;
    requestBody.actionType = input.actionType;

    let response = await axios.post(ANOMALY_DETECTION_API_URL, requestBody);

    let responseData = response.data;
    if (!responseData.bruteForce.result) {
        return {
            status: "GENERAL_ERROR",
            message: "Too many requests. Please try again later."
        }
    }

    if (responseData.isPasswordBreached) {
        return {
            status: "GENERAL_ERROR",
            message: "This password has been detected in a breach. Please set a different password."
        }
    }

    return undefined;
}
```
